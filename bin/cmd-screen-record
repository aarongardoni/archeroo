#!/bin/bash

OUTPUT_DIR="${HOME}/videos"

if [[ ! -d "$OUTPUT_DIR" ]]; then
  mkdir -p $OUTPUT_DIR
fi

start_screenrecording() {
  local filename="$OUTPUT_DIR/screenrecording-$(date +'%Y-%m-%d_%H-%M-%S').mp4"
  # Capture region FIRST (blocks until you select)
  local region=$(slurp -f "%wx%h+%x+%y")

  # THEN start recorder + signal (no background race)
  gpu-screen-recorder -w region -region "$region" -o "$filename" &
  sleep 0.3
}

stop_screenrecording() {
  pkill -SIGINT -f "^gpu-screen-recorder" # SIGINT required to save video properly

  # Wait a maximum of 5 seconds to finish before hard killing
  local count=0
  while pgrep -f "^gpu-screen-recorder" >/dev/null && [ $count -lt 50 ]; do
    sleep 0.1
    count=$((count + 1))
  done

  if pgrep -f "^gpu-screen-recorder" >/dev/null; then
    pkill -9 -f "^gpu-screen-recorder"
    # notify-send "Screen recording error" "Recording process had to be force-killed. Video may be corrupted." -u critical -t 5000
  else
    # notify-send "Screen recording saved to $OUTPUT_DIR" -t 2000
    echo ""
  fi
}

toggle_screenrecording_indicator() {
  pkill -RTMIN+8 waybar
}

screenrecording_active() {
  pgrep -f "^gpu-screen-recorder" >/dev/null >/dev/null
}

if screenrecording_active; then
  stop_screenrecording
  toggle_screenrecording_indicator
  notify-send "Screen recording saved to $OUTPUT_DIR" -t 2000
else
  start_screenrecording
  toggle_screenrecording_indicator
  notify-send "Screen recording started" -t 1000
fi

