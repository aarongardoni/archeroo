#!/bin/bash

fzf_args=(
    --color 'pointer:green,marker:green'
)

filter_valid_apps() {
    local desktop_files=("/usr/share/applications/"*.desktop)

    for file in "${desktop_files[@]}"; do
        if rg -q '^NoDisplay=true$' "$file" 2>/dev/null; then
            continue
        fi

        if rg -q '^Hidden=true$' "$file" 2>/dev/null; then
            continue
        fi

        if ! rg -q '^Type=Application$' "$file" 2>/dev/null; then
            continue
        fi

        if ! rg -q '^Icon=(.*)$' "$file" 2>/dev/null; then
            continue
        fi

        # Print basename without .desktop extension
        basename "${file%.desktop}"
    done
}

app_name=$(filter_valid_apps | fzf "${fzf_args[@]}")

# Add .desktop back for gtk-launch
setsid gtk-launch "${app_name}.desktop"
